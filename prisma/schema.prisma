generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum OtpType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

enum EventVisibility {
  PUBLIC
  PRIVATE
}

enum EventState {
  OPEN_FOR_REGISTRATION
  CLOSED_FOR_REGISTRATION
  CANCELLED
}

enum EventRole {
  ATTENDEE
  MANAGER
  OWNER
}

enum NotificationType {
  REMINDER
  INVITE
  CANCELLATION
  SYSTEM
}

enum NotificationTarget {
  EVENT
  INVITE
}

enum PaymentMethod {
  ONLINE
  AT_EVENT
  FREE
}

enum InviteStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum Permission {
  VIEW_EVENT
  VIEW_INVITES
  VIEW_ATTENDEES
  VIEW_MANAGERS
  SCAN_CODE
  CANCEL_EVENT
  CLOSE_OR_OPEN_REGISTRATION
  INVITE_ATTENDEES
  INVITE_MANAGERS
  UPDATE_EVENT_DETAILS
  REMOVE_REGISTERED_USERS
  REMOVE_MANAGERS
}

model User {
  id              Int      @id @default(autoincrement())
  name            String   @db.VarChar(100)
  username        String   @unique @db.VarChar(30)
  email           String   @unique @db.VarChar(255)
  passwordHash    String   @db.VarChar(255)
  governorate     String   @db.VarChar(100)
  profileImageUrl String?  @db.VarChar(255)
  createdAt       DateTime @default(now())
  isVerified      Boolean  @default(false)

  refreshTokens         RefreshToken[]
  otpCodes              OtpCode[]
  fcmTokens             FcmToken[]
  invitesSent           Invite[]               @relation("SentInvites")
  invitesReceived       Invite[]               @relation("ReceivedInvites")
  ownedEvents           Event[]                @relation("EventOwner")
  sentNotifications     Notification[]         @relation("Sender")
  notificationReceivers NotificationReceiver[]
  userEventRoles        UserEventRole[]
  userEventPermissions  UserEventPermission[]

  @@index([email])
  @@index([username])
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model OtpCode {
  id        Int      @id @default(autoincrement())
  code      String
  type      OtpType
  expiresAt DateTime
  createdAt DateTime @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, code, type])
  @@index([expiresAt])
}

model FcmToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  createdAt DateTime @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model Notification {
  id        Int              @id @default(autoincrement())
  type      NotificationType
  createdAt DateTime         @default(now())

  senderId Int?
  sender   User? @relation("Sender", fields: [senderId], references: [id], onDelete: SetNull)

  targetId   Int?
  targetType NotificationTarget?

  data Json

  notificationReceivers NotificationReceiver[]
}

model NotificationReceiver {
  read Boolean @default(false)

  receiverId Int
  receiver   User @relation(fields: [receiverId], references: [id], onDelete: Cascade)

  notificationId Int
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@id([receiverId, notificationId])
  @@index([notificationId])
  @@index([receiverId])
}

model Invite {
  id        Int          @id @default(autoincrement())
  status    InviteStatus @default(PENDING)
  createdAt DateTime     @default(now())

  roleId Int
  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  senderId Int
  sender   User @relation("SentInvites", fields: [senderId], references: [id], onDelete: Cascade)

  receiverId Int
  receiver   User @relation("ReceivedInvites", fields: [receiverId], references: [id], onDelete: Cascade)

  eventId Int
  event   Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  invitePermissions InvitePermissions[]

  @@unique([receiverId, eventId])
}

model InvitePermissions {
  inviteId Int
  invite   Invite @relation(fields: [inviteId], references: [id], onDelete: Cascade)

  permission Permission

  @@id([inviteId, permission])
  @@index([inviteId])
}

model Event {
  id          Int     @id @default(autoincrement())
  name        String  @db.VarChar(255)
  description String  @db.Text
  latitude    Decimal @db.Decimal(10, 7)
  longitude   Decimal @db.Decimal(10, 7)
  governorate String  @db.VarChar(100)

  paymentMethod PaymentMethod
  price         Decimal?      @db.Decimal(10, 2) // null when FREE

  startAt      DateTime
  duration     Int      @db.SmallInt
  maxAttendees Int
  imageUrl     String?  @db.VarChar(255)

  visibility EventVisibility
  state      EventState      @default(OPEN_FOR_REGISTRATION)
  createdAt  DateTime        @default(now())

  ownerId Int?
  owner   User? @relation("EventOwner", fields: [ownerId], references: [id], onDelete: SetNull)

  invites         Invite[]
  userRoles       UserEventRole[]
  userPermissions UserEventPermission[]

  @@index([name])
  @@index([governorate])
  @@index([startAt])
  @@index([price])
}

model Role {
  id   Int       @id @default(autoincrement())
  role EventRole @unique

  rolePermissions RolePermission[]
  userEventRoles  UserEventRole[]
  invites         Invite[]
}

model RolePermission {
  roleId     Int
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission

  @@id([roleId, permission])
}

model UserEventRole {
  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  eventId Int
  event   Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  roleId Int
  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  attendanceCode String?  @db.Uuid
  attended       Boolean? @default(false)

  permissions UserEventPermission[]

  @@id([userId, eventId])
  @@index([userId, eventId])
}

model UserEventPermission {
  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  eventId Int
  event   Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  permission    Permission
  userEventRole UserEventRole @relation(fields: [userId, eventId], references: [userId, eventId], onDelete: Cascade)

  @@id([userId, eventId, permission])
  @@index([userId, eventId])
}
